"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const connection_1 = __importDefault(require("../browser/connection"));
const injectables_1 = require("../assets/injectables");
const about_blank_page_markup_1 = __importDefault(require("./about-blank-page-markup"));
const lodash_1 = require("lodash");
const debug_1 = __importDefault(require("debug"));
const http_status_codes_1 = require("http-status-codes");
const ALL_DOCUMENT_RESPONSES = {
    urlPattern: '*',
    resourceType: 'Document',
    requestStage: 'Response',
};
const CONTENT_SECURITY_POLICY_HEADER_NAMES = [
    'content-security-policy',
    'content-security-policy-report-only',
];
const debugLogger = (0, debug_1.default)('testcafe:proxyless:resource-injector');
class ResourceInjector {
    constructor(browserId) {
        this._browserId = browserId;
        this._idlePageUrl = this._getIdlePageUrl(browserId);
    }
    _getIdlePageUrl(browserId) {
        var _a;
        return ((_a = connection_1.default.getById(browserId)) === null || _a === void 0 ? void 0 : _a.idleUrl) || '';
    }
    _getResponseAsString(response) {
        return response.base64Encoded
            ? Buffer.from(response.body, 'base64').toString()
            : response.body;
    }
    _isServicePage(url) {
        const browserConnection = connection_1.default.getById(this._browserId);
        const proxy = browserConnection.browserConnectionGateway.proxy;
        return url.startsWith(proxy.server1Info.domain);
    }
    async _prepareInjectableResources() {
        var _a;
        const browserConnection = connection_1.default.getById(this._browserId);
        const proxy = browserConnection.browserConnectionGateway.proxy;
        const windowId = browserConnection.activeWindowId;
        const currentTestRun = (_a = browserConnection === null || browserConnection === void 0 ? void 0 : browserConnection.currentJob) === null || _a === void 0 ? void 0 : _a.currentTestRun;
        if (!currentTestRun)
            return null;
        const taskScript = await currentTestRun.session.getTaskScript({
            referer: '',
            cookieUrl: '',
            isIframe: false,
            withPayload: true,
            serverInfo: proxy.server1Info,
            windowId,
        });
        const injectableResources = {
            stylesheets: [
                injectables_1.TESTCAFE_UI_STYLES,
            ],
            scripts: [
                ...testcafe_hammerhead_1.INJECTABLE_SCRIPTS.map(hs => (0, testcafe_hammerhead_1.getAssetPath)(hs, proxy.options.developmentMode)),
                ...injectables_1.SCRIPTS.map(s => (0, testcafe_hammerhead_1.getAssetPath)(s, proxy.options.developmentMode)),
            ],
            embeddedScripts: [taskScript],
        };
        injectableResources.scripts = injectableResources.scripts.map(script => proxy.resolveRelativeServiceUrl(script));
        injectableResources.stylesheets = injectableResources.stylesheets.map(style => proxy.resolveRelativeServiceUrl(style));
        return injectableResources;
    }
    _processResponseHeaders(headers) {
        if (!headers)
            return [];
        (0, lodash_1.remove)(headers, header => CONTENT_SECURITY_POLICY_HEADER_NAMES.includes(header.name));
        return headers;
    }
    _tryToHandlePageError(err, url) {
        var _a;
        const browserConnection = connection_1.default.getById(this._browserId);
        const currentTestRun = (_a = browserConnection === null || browserConnection === void 0 ? void 0 : browserConnection.currentJob) === null || _a === void 0 ? void 0 : _a.currentTestRun;
        if (!currentTestRun)
            return;
        const ctxMock = {
            reqOpts: { url },
        };
        currentTestRun.session.handlePageError(ctxMock, err);
    }
    async _handleHTTPPages(client) {
        await client.Fetch.enable({ patterns: [ALL_DOCUMENT_RESPONSES] });
        client.Fetch.on('requestPaused', async (params) => {
            const { requestId, responseHeaders, responseStatusCode, } = params;
            if (this._isServicePage(params.request.url))
                await client.Fetch.continueRequest({ requestId });
            else {
                try {
                    const responseObj = await client.Fetch.getResponseBody({ requestId });
                    const responseStr = this._getResponseAsString(responseObj);
                    const injectableResources = await this._prepareInjectableResources();
                    // NOTE: an unhandled exception interrupts the test execution,
                    // and we are force to redirect manually to the idle page.
                    if (!injectableResources) {
                        await client.Fetch.fulfillRequest({
                            requestId,
                            responseCode: http_status_codes_1.StatusCodes.MOVED_PERMANENTLY,
                            responseHeaders: [
                                { name: 'location', value: this._idlePageUrl },
                            ],
                        });
                    }
                    else {
                        const updatedResponseStr = (0, testcafe_hammerhead_1.injectResources)(responseStr, injectableResources);
                        await client.Fetch.fulfillRequest({
                            requestId,
                            responseCode: responseStatusCode || http_status_codes_1.StatusCodes.OK,
                            responseHeaders: this._processResponseHeaders(responseHeaders),
                            body: Buffer.from(updatedResponseStr).toString('base64'),
                        });
                    }
                }
                catch (err) {
                    this._tryToHandlePageError(err, params.request.url);
                    debugLogger('Failed to process request: %s', params.request.url);
                }
            }
        });
    }
    _topFrameNavigationToAboutBlank(event) {
        if (event.frame.url !== testcafe_hammerhead_1.SPECIAL_BLANK_PAGE)
            return false;
        if (event.type !== 'Navigation')
            return false;
        if (event.frame.parentId)
            return false;
        return true;
    }
    async _handleAboutBlankPage(client) {
        await client.Page.enable();
        client.Page.on('frameNavigated', async (params) => {
            if (!this._topFrameNavigationToAboutBlank(params))
                return;
            const injectableResources = await this._prepareInjectableResources();
            const html = (0, testcafe_hammerhead_1.injectResources)(about_blank_page_markup_1.default, injectableResources);
            await client.Page.setDocumentContent({
                frameId: params.frame.id,
                html,
            });
        });
    }
    async setup(client) {
        await this._handleHTTPPages(client);
        await this._handleAboutBlankPage(client);
    }
}
exports.default = ResourceInjector;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UtaW5qZWN0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcHJveHlsZXNzL3Jlc291cmNlLWluamVjdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBT0EsNkRBTTZCO0FBQzdCLHVFQUFzRDtBQUN0RCx1REFBb0U7QUFDcEUsd0ZBQWdFO0FBQ2hFLG1DQUFnQztBQUNoQyxrREFBMEI7QUFDMUIseURBQWdEO0FBRWhELE1BQU0sc0JBQXNCLEdBQUc7SUFDM0IsVUFBVSxFQUFJLEdBQUc7SUFDakIsWUFBWSxFQUFFLFVBQVU7SUFDeEIsWUFBWSxFQUFFLFVBQVU7Q0FDVCxDQUFDO0FBRXBCLE1BQU0sb0NBQW9DLEdBQUc7SUFDekMseUJBQXlCO0lBQ3pCLHFDQUFxQztDQUN4QyxDQUFDO0FBRUYsTUFBTSxXQUFXLEdBQUcsSUFBQSxlQUFLLEVBQUMsc0NBQXNDLENBQUMsQ0FBQztBQUVsRSxNQUFxQixnQkFBZ0I7SUFJakMsWUFBb0IsU0FBaUI7UUFDakMsSUFBSSxDQUFDLFVBQVUsR0FBSyxTQUFTLENBQUM7UUFDOUIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFFTyxlQUFlLENBQUUsU0FBaUI7O1FBQ3RDLE9BQU8sQ0FBQSxNQUFBLG9CQUFpQixDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsMENBQ3JDLE9BQU8sS0FBSSxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVPLG9CQUFvQixDQUFFLFFBQWlDO1FBQzNELE9BQU8sUUFBUSxDQUFDLGFBQWE7WUFDekIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQyxRQUFRLEVBQUU7WUFDakQsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7SUFDeEIsQ0FBQztJQUVPLGNBQWMsQ0FBRSxHQUFXO1FBQy9C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QyxFQUFFLENBQUMsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLE1BQTJCLEVBQUUsRUFBRTtZQUNuRSxJQUFJLENBQUMsSUFBSSxDQUFDLCtCQUErQixDQUFDLE1BQU0sQ0FBQztnQkFDN0MsT0FBTztZQUVYLE1BQU0sbUJBQW1CLEdBQUcsTUFBTSxJQUFJLENBQUMsMkJBQTJCLEVBQTZCLENBQUM7WUFDaEcsTUFBTSxJQUFJLEdBQWtCLElBQUEscUNBQWUsRUFBQyxpQ0FBdUIsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1lBRTFGLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQztnQkFDakMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDeEIsSUFBSTthQUNQLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLEtBQUssQ0FBQyxLQUFLLENBQUUsTUFBbUI7UUFDbkMsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEMsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDN0MsQ0FBQztDQUNKO0FBeEtELG1DQXdLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByb3RvY29sQXBpIH0gZnJvbSAnY2hyb21lLXJlbW90ZS1pbnRlcmZhY2UnO1xuaW1wb3J0IFByb3RvY29sIGZyb20gJ2RldnRvb2xzLXByb3RvY29sJztcbmltcG9ydCBSZXF1ZXN0UGF1c2VkRXZlbnQgPSBQcm90b2NvbC5GZXRjaC5SZXF1ZXN0UGF1c2VkRXZlbnQ7XG5pbXBvcnQgUmVxdWVzdFBhdHRlcm4gPSBQcm90b2NvbC5GZXRjaC5SZXF1ZXN0UGF0dGVybjtcbmltcG9ydCBHZXRSZXNwb25zZUJvZHlSZXNwb25zZSA9IFByb3RvY29sLkZldGNoLkdldFJlc3BvbnNlQm9keVJlc3BvbnNlO1xuaW1wb3J0IEZyYW1lTmF2aWdhdGVkRXZlbnQgPSBQcm90b2NvbC5QYWdlLkZyYW1lTmF2aWdhdGVkRXZlbnQ7XG5pbXBvcnQgSGVhZGVyRW50cnkgPSBQcm90b2NvbC5GZXRjaC5IZWFkZXJFbnRyeTtcbmltcG9ydCB7XG4gICAgaW5qZWN0UmVzb3VyY2VzLFxuICAgIFBhZ2VJbmplY3RhYmxlUmVzb3VyY2VzLFxuICAgIElOSkVDVEFCTEVfU0NSSVBUUyBhcyBIQU1NRVJIRUFEX0lOSkVDVEFCTEVfU0NSSVBUUyxcbiAgICBTUEVDSUFMX0JMQU5LX1BBR0UsXG4gICAgZ2V0QXNzZXRQYXRoLFxufSBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcbmltcG9ydCBCcm93c2VyQ29ubmVjdGlvbiBmcm9tICcuLi9icm93c2VyL2Nvbm5lY3Rpb24nO1xuaW1wb3J0IHsgU0NSSVBUUywgVEVTVENBRkVfVUlfU1RZTEVTIH0gZnJvbSAnLi4vYXNzZXRzL2luamVjdGFibGVzJztcbmltcG9ydCBBQk9VVF9CTEFOS19QQUdFX01BUktVUCBmcm9tICcuL2Fib3V0LWJsYW5rLXBhZ2UtbWFya3VwJztcbmltcG9ydCB7IHJlbW92ZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IHsgU3RhdHVzQ29kZXMgfSBmcm9tICdodHRwLXN0YXR1cy1jb2Rlcyc7XG5cbmNvbnN0IEFMTF9ET0NVTUVOVF9SRVNQT05TRVMgPSB7XG4gICAgdXJsUGF0dGVybjogICAnKicsXG4gICAgcmVzb3VyY2VUeXBlOiAnRG9jdW1lbnQnLFxuICAgIHJlcXVlc3RTdGFnZTogJ1Jlc3BvbnNlJyxcbn0gYXMgUmVxdWVzdFBhdHRlcm47XG5cbmNvbnN0IENPTlRFTlRfU0VDVVJJVFlfUE9MSUNZX0hFQURFUl9OQU1FUyA9IFtcbiAgICAnY29udGVudC1zZWN1cml0eS1wb2xpY3knLFxuICAgICdjb250ZW50LXNlY3VyaXR5LXBvbGljeS1yZXBvcnQtb25seScsXG5dO1xuXG5jb25zdCBkZWJ1Z0xvZ2dlciA9IGRlYnVnKCd0ZXN0Y2FmZTpwcm94eWxlc3M6cmVzb3VyY2UtaW5qZWN0b3InKTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVzb3VyY2VJbmplY3RvciB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfYnJvd3NlcklkOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfaWRsZVBhZ2VVcmw6IHN0cmluZztcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvciAoYnJvd3NlcklkOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5fYnJvd3NlcklkICAgPSBicm93c2VySWQ7XG4gICAgICAgIHRoaXMuX2lkbGVQYWdlVXJsID0gdGhpcy5fZ2V0SWRsZVBhZ2VVcmwoYnJvd3NlcklkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRJZGxlUGFnZVVybCAoYnJvd3NlcklkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gQnJvd3NlckNvbm5lY3Rpb24uZ2V0QnlJZChicm93c2VySWQpXG4gICAgICAgICAgICA/LmlkbGVVcmwgfHwgJyc7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0UmVzcG9uc2VBc1N0cmluZyAocmVzcG9uc2U6IEdldFJlc3BvbnNlQm9keVJlc3BvbnNlKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhc2U2NEVuY29kZWRcbiAgICAgICAgICAgID8gQnVmZmVyLmZyb20ocmVzcG9uc2UuYm9keSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKClcbiAgICAgICAgICAgIDogcmVzcG9uc2UuYm9keTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pc1NlcnZpY2VQYWdlICh1cmw6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBicm93c2VyQ29ubmVjdGlvbiA9IEJyb3dzZXJDb25uZWN0aW9uLmdldEJ5SWQodGhpcy5fYnJvd3NlcklkKSBhcyBCcm93c2VyQ29ubmVjdGlvbjtcbiAgICAgICAgY29uc3QgcHJveHkgICAgICAgICAgICAgPSBicm93c2VyQ29ubmVjdGlvbi5icm93c2VyQ29ubmVjdGlvbkdhdGV3YXkucHJveHk7XG5cbiAgICAgICAgcmV0dXJuIHVybC5zdGFydHNXaXRoKHByb3h5LnNlcnZlcjFJbmZvLmRvbWFpbik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfcHJlcGFyZUluamVjdGFibGVSZXNvdXJjZXMgKCk6IFByb21pc2U8UGFnZUluamVjdGFibGVSZXNvdXJjZXMgfCBudWxsPiB7XG4gICAgICAgIGNvbnN0IGJyb3dzZXJDb25uZWN0aW9uID0gQnJvd3NlckNvbm5lY3Rpb24uZ2V0QnlJZCh0aGlzLl9icm93c2VySWQpIGFzIEJyb3dzZXJDb25uZWN0aW9uO1xuICAgICAgICBjb25zdCBwcm94eSAgICAgICAgICAgICA9IGJyb3dzZXJDb25uZWN0aW9uLmJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheS5wcm94eTtcbiAgICAgICAgY29uc3Qgd2luZG93SWQgICAgICAgICAgPSBicm93c2VyQ29ubmVjdGlvbi5hY3RpdmVXaW5kb3dJZDtcbiAgICAgICAgY29uc3QgY3VycmVudFRlc3RSdW4gICAgPSBicm93c2VyQ29ubmVjdGlvbj8uY3VycmVudEpvYj8uY3VycmVudFRlc3RSdW47XG5cbiAgICAgICAgaWYgKCFjdXJyZW50VGVzdFJ1bilcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgICAgIGNvbnN0IHRhc2tTY3JpcHQgPSBhd2FpdCBjdXJyZW50VGVzdFJ1bi5zZXNzaW9uLmdldFRhc2tTY3JpcHQoe1xuICAgICAgICAgICAgcmVmZXJlcjogICAgICcnLFxuICAgICAgICAgICAgY29va2llVXJsOiAgICcnLFxuICAgICAgICAgICAgaXNJZnJhbWU6ICAgIGZhbHNlLFxuICAgICAgICAgICAgd2l0aFBheWxvYWQ6IHRydWUsXG4gICAgICAgICAgICBzZXJ2ZXJJbmZvOiAgcHJveHkuc2VydmVyMUluZm8sXG4gICAgICAgICAgICB3aW5kb3dJZCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgaW5qZWN0YWJsZVJlc291cmNlcyA9IHtcbiAgICAgICAgICAgIHN0eWxlc2hlZXRzOiBbXG4gICAgICAgICAgICAgICAgVEVTVENBRkVfVUlfU1RZTEVTLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIHNjcmlwdHM6IFtcbiAgICAgICAgICAgICAgICAuLi5IQU1NRVJIRUFEX0lOSkVDVEFCTEVfU0NSSVBUUy5tYXAoaHMgPT4gZ2V0QXNzZXRQYXRoKGhzLCBwcm94eS5vcHRpb25zLmRldmVsb3BtZW50TW9kZSkpLFxuICAgICAgICAgICAgICAgIC4uLlNDUklQVFMubWFwKHMgPT4gZ2V0QXNzZXRQYXRoKHMsIHByb3h5Lm9wdGlvbnMuZGV2ZWxvcG1lbnRNb2RlKSksXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgZW1iZWRkZWRTY3JpcHRzOiBbdGFza1NjcmlwdF0sXG4gICAgICAgIH07XG5cbiAgICAgICAgaW5qZWN0YWJsZVJlc291cmNlcy5zY3JpcHRzICAgICA9IGluamVjdGFibGVSZXNvdXJjZXMuc2NyaXB0cy5tYXAoc2NyaXB0ID0+IHByb3h5LnJlc29sdmVSZWxhdGl2ZVNlcnZpY2VVcmwoc2NyaXB0KSk7XG4gICAgICAgIGluamVjdGFibGVSZXNvdXJjZXMuc3R5bGVzaGVldHMgPSBpbmplY3RhYmxlUmVzb3VyY2VzLnN0eWxlc2hlZXRzLm1hcChzdHlsZSA9PiBwcm94eS5yZXNvbHZlUmVsYXRpdmVTZXJ2aWNlVXJsKHN0eWxlKSk7XG5cbiAgICAgICAgcmV0dXJuIGluamVjdGFibGVSZXNvdXJjZXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcHJvY2Vzc1Jlc3BvbnNlSGVhZGVycyAoaGVhZGVyczogSGVhZGVyRW50cnlbXSB8IHVuZGVmaW5lZCk6IEhlYWRlckVudHJ5W10ge1xuICAgICAgICBpZiAoIWhlYWRlcnMpXG4gICAgICAgICAgICByZXR1cm4gW107XG5cbiAgICAgICAgcmVtb3ZlKGhlYWRlcnMsIGhlYWRlciA9PiBDT05URU5UX1NFQ1VSSVRZX1BPTElDWV9IRUFERVJfTkFNRVMuaW5jbHVkZXMoaGVhZGVyLm5hbWUpKTtcblxuICAgICAgICByZXR1cm4gaGVhZGVycztcbiAgICB9XG5cbiAgICBwcml2YXRlIF90cnlUb0hhbmRsZVBhZ2VFcnJvciAoZXJyOiBFcnJvciwgdXJsOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgYnJvd3NlckNvbm5lY3Rpb24gPSBCcm93c2VyQ29ubmVjdGlvbi5nZXRCeUlkKHRoaXMuX2Jyb3dzZXJJZCkgYXMgQnJvd3NlckNvbm5lY3Rpb247XG4gICAgICAgIGNvbnN0IGN1cnJlbnRUZXN0UnVuICAgID0gYnJvd3NlckNvbm5lY3Rpb24/LmN1cnJlbnRKb2I/LmN1cnJlbnRUZXN0UnVuO1xuXG4gICAgICAgIGlmICghY3VycmVudFRlc3RSdW4pXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgY29uc3QgY3R4TW9jayA9IHtcbiAgICAgICAgICAgIHJlcU9wdHM6IHsgdXJsIH0sXG4gICAgICAgIH07XG5cbiAgICAgICAgY3VycmVudFRlc3RSdW4uc2Vzc2lvbi5oYW5kbGVQYWdlRXJyb3IoY3R4TW9jaywgZXJyKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9oYW5kbGVIVFRQUGFnZXMgKGNsaWVudDogUHJvdG9jb2xBcGkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgY2xpZW50LkZldGNoLmVuYWJsZSh7IHBhdHRlcm5zOiBbQUxMX0RPQ1VNRU5UX1JFU1BPTlNFU10gfSk7XG5cbiAgICAgICAgY2xpZW50LkZldGNoLm9uKCdyZXF1ZXN0UGF1c2VkJywgYXN5bmMgKHBhcmFtczogUmVxdWVzdFBhdXNlZEV2ZW50KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyxcbiAgICAgICAgICAgICAgICByZXNwb25zZVN0YXR1c0NvZGUsXG4gICAgICAgICAgICB9ID0gcGFyYW1zO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5faXNTZXJ2aWNlUGFnZShwYXJhbXMucmVxdWVzdC51cmwpKVxuICAgICAgICAgICAgICAgIGF3YWl0IGNsaWVudC5GZXRjaC5jb250aW51ZVJlcXVlc3QoeyByZXF1ZXN0SWQgfSk7XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZU9iaiAgICAgICAgID0gYXdhaXQgY2xpZW50LkZldGNoLmdldFJlc3BvbnNlQm9keSh7IHJlcXVlc3RJZCB9KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VTdHIgICAgICAgICA9IHRoaXMuX2dldFJlc3BvbnNlQXNTdHJpbmcocmVzcG9uc2VPYmopO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmplY3RhYmxlUmVzb3VyY2VzID0gYXdhaXQgdGhpcy5fcHJlcGFyZUluamVjdGFibGVSZXNvdXJjZXMoKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBOT1RFOiBhbiB1bmhhbmRsZWQgZXhjZXB0aW9uIGludGVycnVwdHMgdGhlIHRlc3QgZXhlY3V0aW9uLFxuICAgICAgICAgICAgICAgICAgICAvLyBhbmQgd2UgYXJlIGZvcmNlIHRvIHJlZGlyZWN0IG1hbnVhbGx5IHRvIHRoZSBpZGxlIHBhZ2UuXG4gICAgICAgICAgICAgICAgICAgIGlmICghaW5qZWN0YWJsZVJlc291cmNlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgY2xpZW50LkZldGNoLmZ1bGZpbGxSZXF1ZXN0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VDb2RlOiAgICBTdGF0dXNDb2Rlcy5NT1ZFRF9QRVJNQU5FTlRMWSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnM6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBuYW1lOiAnbG9jYXRpb24nLCB2YWx1ZTogdGhpcy5faWRsZVBhZ2VVcmwgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1cGRhdGVkUmVzcG9uc2VTdHIgID0gaW5qZWN0UmVzb3VyY2VzKHJlc3BvbnNlU3RyLCBpbmplY3RhYmxlUmVzb3VyY2VzKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgY2xpZW50LkZldGNoLmZ1bGZpbGxSZXF1ZXN0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VDb2RlOiAgICByZXNwb25zZVN0YXR1c0NvZGUgfHwgU3RhdHVzQ29kZXMuT0ssXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzOiB0aGlzLl9wcm9jZXNzUmVzcG9uc2VIZWFkZXJzKHJlc3BvbnNlSGVhZGVycyksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9keTogICAgICAgICAgICBCdWZmZXIuZnJvbSh1cGRhdGVkUmVzcG9uc2VTdHIpLnRvU3RyaW5nKCdiYXNlNjQnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdHJ5VG9IYW5kbGVQYWdlRXJyb3IoZXJyIGFzIEVycm9yLCBwYXJhbXMucmVxdWVzdC51cmwpO1xuXG4gICAgICAgICAgICAgICAgICAgIGRlYnVnTG9nZ2VyKCdGYWlsZWQgdG8gcHJvY2VzcyByZXF1ZXN0OiAlcycsIHBhcmFtcy5yZXF1ZXN0LnVybCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF90b3BGcmFtZU5hdmlnYXRpb25Ub0Fib3V0QmxhbmsgKGV2ZW50OiBGcmFtZU5hdmlnYXRlZEV2ZW50KTogYm9vbGVhbiB7XG4gICAgICAgIGlmIChldmVudC5mcmFtZS51cmwgIT09IFNQRUNJQUxfQkxBTktfUEFHRSlcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICBpZiAoZXZlbnQudHlwZSAhPT0gJ05hdmlnYXRpb24nKVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgIGlmIChldmVudC5mcmFtZS5wYXJlbnRJZClcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9oYW5kbGVBYm91dEJsYW5rUGFnZSAoY2xpZW50OiBQcm90b2NvbEFwaSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBhd2FpdCBjbGllbnQuUGFnZS5lbmFibGUoKTtcblxuICAgICAgICBjbGllbnQuUGFnZS5vbignZnJhbWVOYXZpZ2F0ZWQnLCBhc3luYyAocGFyYW1zOiBGcmFtZU5hdmlnYXRlZEV2ZW50KSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuX3RvcEZyYW1lTmF2aWdhdGlvblRvQWJvdXRCbGFuayhwYXJhbXMpKVxuICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgY29uc3QgaW5qZWN0YWJsZVJlc291cmNlcyA9IGF3YWl0IHRoaXMuX3ByZXBhcmVJbmplY3RhYmxlUmVzb3VyY2VzKCkgYXMgUGFnZUluamVjdGFibGVSZXNvdXJjZXM7XG4gICAgICAgICAgICBjb25zdCBodG1sICAgICAgICAgICAgICAgID0gaW5qZWN0UmVzb3VyY2VzKEFCT1VUX0JMQU5LX1BBR0VfTUFSS1VQLCBpbmplY3RhYmxlUmVzb3VyY2VzKTtcblxuICAgICAgICAgICAgYXdhaXQgY2xpZW50LlBhZ2Uuc2V0RG9jdW1lbnRDb250ZW50KHtcbiAgICAgICAgICAgICAgICBmcmFtZUlkOiBwYXJhbXMuZnJhbWUuaWQsXG4gICAgICAgICAgICAgICAgaHRtbCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgc2V0dXAgKGNsaWVudDogUHJvdG9jb2xBcGkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5faGFuZGxlSFRUUFBhZ2VzKGNsaWVudCk7XG4gICAgICAgIGF3YWl0IHRoaXMuX2hhbmRsZUFib3V0QmxhbmtQYWdlKGNsaWVudCk7XG4gICAgfVxufVxuIl19